<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimating death rates from sibling history data • siblingsurvival</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Estimating death rates from sibling history data">
<meta property="og:description" content="siblingsurvival">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-56MJYKC8R7"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-56MJYKC8R7');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">siblingsurvival</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/preparing-data.html">Preparing DHS data</a>
    </li>
    <li>
      <a href="../articles/sibling-estimates.html">Estimating death rates from sibling history data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="sibling-estimates_files/header-attrs-2.5/header-attrs.js"></script><link href="sibling-estimates_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="sibling-estimates_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Estimating death rates from sibling history data</h1>
                        <h4 class="author">Dennis M. Feehan</h4>
            
            <h4 class="date">2020-11-08</h4>
      
      
      <div class="hidden name"><code>sibling-estimates.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">siblingsurvival</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="co">#&gt; ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.0 ──</span>
<span class="co">#&gt; ✓ ggplot2 3.3.2     ✓ purrr   0.3.4</span>
<span class="co">#&gt; ✓ tibble  3.0.4     ✓ dplyr   1.0.2</span>
<span class="co">#&gt; ✓ tidyr   1.1.2     ✓ stringr 1.4.0</span>
<span class="co">#&gt; ✓ readr   1.4.0     ✓ forcats 0.5.0</span>
<span class="co">#&gt; ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──</span>
<span class="co">#&gt; x dplyr::filter() masks stats::filter()</span>
<span class="co">#&gt; x dplyr::lag()    masks stats::lag()</span>
<span class="co"># be sure you have at least version 0.0.2.9000 of surveybootstrap</span>
<span class="co"># run devtools::install_github('dfeehan/surveybootstrap')</span>
<span class="co"># for the most recent version</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">surveybootstrap</span><span class="op">)</span>  

<span class="co"># this is helfpul for timing</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/collectivemedia/tictoc">tictoc</a></span><span class="op">)</span></pre></div>
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>It will be helpful to define a few important terms before we start our analysis:</p>
<ul>
<li>
<code>ego</code> - an ego is a survey respondent</li>
<li>
<code>cell</code> - a cell is a generic group for which we wish to produce estimates. Usually, a cell is defined by a time period, an age range, and a sex. So, for example, a cell might be women who were age 30-34 in 2015.</li>
</ul>
<p>For the purposes of this vignette, we’ll assume that we starting from two datasets:</p>
<ul>
<li>one dataset has a row for each survey respondent</li>
<li>one dataset has a row for each sibling who is reported by a survey respondent</li>
</ul>
<p>We’ll then calculate estimates from the sibling histories in three main steps:</p>
<ol style="list-style-type: decimal">
<li>Create an <strong>esc</strong> dataset, so called because there is row for each <strong>e</strong>go X <strong>s</strong>ibling X <strong>c</strong>ell</li>
<li>Aggregate this esc dataset up into an <strong>ec</strong> dataset, which has a row for the reports made by each ego for each cell</li>
<li>Aggregate this ec dataset up into estimates for death rates, using either the individual or aggregate visibility approach (or both)</li>
</ol>
<div id="opening-up-the-demo-datasets" class="section level3">
<h3 class="hasAnchor">
<a href="#opening-up-the-demo-datasets" class="anchor"></a>Opening up the demo datasets</h3>
<p>We’ll start by opening up the demonstration DHS dataset.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">model_dhs_dat</span><span class="op">)</span></pre></div>
<p>Now we’ll use <code>prep_dhs_sib_histories</code> to ready the sibling histories for analysis. (Please see the <a href="preparing-data.html">Preparing Data</a> vignette for more details.)</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">prepped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep_dhs_sib_histories.html">prep_dhs_sib_histories</a></span><span class="op">(</span><span class="va">model_dhs_dat</span>,
                                  varmap <span class="op">=</span> <span class="va">sibhist_varmap_dhs6</span>,
                                  keep_missing <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Warning: `select_()` is deprecated as of dplyr 0.7.0.</span>
<span class="co">#&gt; Please use `select()` instead.</span>
<span class="co">#&gt; This warning is displayed once every 8 hours.</span>
<span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span>
<span class="co">#&gt; Warning: `mutate_()` is deprecated as of dplyr 0.7.0.</span>
<span class="co">#&gt; Please use `mutate()` instead.</span>
<span class="co">#&gt; See vignette('programming') for more help</span>
<span class="co">#&gt; This warning is displayed once every 8 hours.</span>
<span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span>
<span class="co">#&gt; Warning: `filter_()` is deprecated as of dplyr 0.7.0.</span>
<span class="co">#&gt; Please use `filter()` instead.</span>
<span class="co">#&gt; See vignette('programming') for more help</span>
<span class="co">#&gt; This warning is displayed once every 8 hours.</span>
<span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span>
<span class="co">#&gt; 638 out of 35082 (1.82%) reports about sibs have unknown survival status.</span>
<span class="co">#&gt; 602 out of 35082 (1.72%) reports about sibs have unknown sex.</span>
<span class="co">#&gt; Removing reported sibs missing survival status or sex.</span>
<span class="co">#&gt; ... this removes  642  out of  35082  ( 1.83 %)  sibling reports.</span>

<span class="co"># we'll only keep the variable we will need for this analysis</span>
<span class="va">ex.ego</span> <span class="op">&lt;-</span> <span class="va">prepped</span><span class="op">$</span><span class="va">ego.dat</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">caseid</span>, <span class="va">psu</span>, <span class="va">stratum_analysis</span>, <span class="va">age.cat</span>, <span class="va">sex</span>, <span class="va">wwgt</span><span class="op">)</span>
<span class="va">ex.sib</span> <span class="op">&lt;-</span> <span class="va">prepped</span><span class="op">$</span><span class="va">sib.dat</span></pre></div>
<p>Let’s take a look at the datasets we’ve produced. First, here’s a dataset that has information about survey respondents. (We’ll refer to these survey respondents as ‘ego’):</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu">glimpse</span><span class="op">(</span><span class="va">ex.ego</span><span class="op">)</span>
<span class="co">#&gt; Rows: 8,348</span>
<span class="co">#&gt; Columns: 6</span>
<span class="co">#&gt; $ caseid           &lt;chr&gt; "        1  1  2", "        1  3  2", "        1  4 …</span>
<span class="co">#&gt; $ psu              &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span>
<span class="co">#&gt; $ stratum_analysis &lt;dbl&gt; 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, …</span>
<span class="co">#&gt; $ age.cat          &lt;fct&gt; "[30,35)", "[20,25)", "[40,45)", "[25,30)", "[25,30)…</span>
<span class="co">#&gt; $ sex              &lt;chr&gt; "f", "f", "f", "f", "f", "f", "f", "f", "f", "f", "f…</span>
<span class="co">#&gt; $ wwgt             &lt;dbl&gt; 1.057703, 1.057703, 1.057703, 1.057703, 1.057703, 1.…</span></pre></div>
<p>And here’s a long-form version of the sibling history data – there’s one row for each reported sibling.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu">glimpse</span><span class="op">(</span><span class="va">ex.sib</span><span class="op">)</span>
<span class="co">#&gt; Rows: 34,440</span>
<span class="co">#&gt; Columns: 24</span>
<span class="co">#&gt; $ .tmpid                  &lt;chr&gt; "        1  1  2", "        1  3  2", "      …</span>
<span class="co">#&gt; $ caseid                  &lt;chr&gt; "        1  1  2", "        1  3  2", "      …</span>
<span class="co">#&gt; $ wwgt                    &lt;dbl&gt; 1.057703, 1.057703, 1.057703, 1.057703, 1.057…</span>
<span class="co">#&gt; $ psu                     &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span>
<span class="co">#&gt; $ doi                     &lt;dbl&gt; 1386, 1386, 1386, 1386, 1386, 1386, 1386, 138…</span>
<span class="co">#&gt; $ sibindex                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span>
<span class="co">#&gt; $ sib.sex                 &lt;chr&gt; "m", "f", "m", "f", "m", "f", "m", "f", "m", …</span>
<span class="co">#&gt; $ sib.alive               &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, …</span>
<span class="co">#&gt; $ sib.age                 &lt;dbl&gt; 42, 27, 46, 33, 40, 49, 22, 30, 49, 50, 35, N…</span>
<span class="co">#&gt; $ sib.dob                 &lt;dbl&gt; 876, 1056, 828, 984, 900, 792, 1116, 1020, 79…</span>
<span class="co">#&gt; $ sib.marital.status      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ sib.death.yrsago        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 3…</span>
<span class="co">#&gt; $ sib.death.age           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 4…</span>
<span class="co">#&gt; $ sib.death.date          &lt;dbl&gt; -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1…</span>
<span class="co">#&gt; $ sib.died.pregnant       &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ sib.died.bc.pregnancy   &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ sib.death.cause         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ sib.time.delivery.death &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ sib.place.death         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ sib.num.children        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ sib.death.year          &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span>
<span class="co">#&gt; $ alternum                &lt;chr&gt; "01", "01", "01", "01", "01", "01", "01", "01…</span>
<span class="co">#&gt; $ sib.endobs              &lt;dbl&gt; 1386, 1386, 1386, 1386, 1386, 1386, 1386, 138…</span>
<span class="co">#&gt; $ sibid                   &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14…</span></pre></div>
</div>
<div id="laying-the-groundwork" class="section level3">
<h3 class="hasAnchor">
<a href="#laying-the-groundwork" class="anchor"></a>Laying the groundwork</h3>
<p>First, we’ll need to add an indicator variable for each sibling’s frame population membership. In other words, we need to create a variable that has the value 1 for each sibling who was eligible to respond to the survey, and 0 otherwise. In this example data, we’ll assume that conditions similar to a typical DHS survey hold: i.e., we’ll assume the survey design was such that siblings would have been eligible to respond if they</p>
<ul>
<li>are alive</li>
<li>are female</li>
<li>are between the ages of 15 and 50</li>
</ul>
<p>For a given survey, these criteria will differ. You’ll have to find out what the criteria for inclusion in the frame population were in order to produce estimates from sibling histories</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">ex.sib</span> <span class="op">&lt;-</span> <span class="va">ex.sib</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>in.F <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">(</span><span class="va">sib.alive</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">sib.age</span> <span class="op">&gt;=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">sib.age</span> <span class="op">&lt;=</span> <span class="fl">49</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">sib.sex</span> <span class="op">==</span> <span class="st">'f'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Let’s look at the distribution of frame population membership</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">ex.sib</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">in.F</span>, useNA<span class="op">=</span><span class="st">'ifany'</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; in.F</span>
<span class="co">#&gt;     0     1  &lt;NA&gt; </span>
<span class="co">#&gt; 22826 11513   101</span></pre></div>
<p>In this example dataset, a small number of the <code>in.F</code> values is missing. (In a real dataset, there could well be more.) Since we need to be able to determine whether or not each sibling is on in the frame population, we would drop siblings missing <code>in.F</code> values from the analysis.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">ex.sib</span> <span class="op">&lt;-</span> <span class="va">ex.sib</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">in.F</span><span class="op">)</span><span class="op">)</span> </pre></div>
</div>
<div id="specifying-cells" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-cells" class="anchor"></a>Specifying cells</h3>
<p>When we produce estimated death rates from sibling histories, we usually do so for different sex X age group X time period combinations. These are called <em>cells</em>.</p>
<p>Our next step is to create an object that describes the cells that we plan to produce death rate estimates for. This means we need to specify the time period and age groups that we’ll be using. We’ll use the helper function <code>cell_config</code> to do this:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">cc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cell_config.html">cell_config</a></span><span class="op">(</span>age.groups<span class="op">=</span><span class="st">'5yr'</span>, 
                  time.periods<span class="op">=</span><span class="st">'7yr_beforeinterview'</span>,
                  start.obs<span class="op">=</span><span class="st">'sib.dob'</span>,    <span class="co"># date of birth</span>
                  end.obs<span class="op">=</span><span class="st">'sib.endobs'</span>,   <span class="co"># either the date respondent was interviewed (if sib is alive) or date of death (if sib is dead)</span>
                  event<span class="op">=</span><span class="st">'sib.death.date'</span>, <span class="co"># date of death (for sibs who died)</span>
                  age.offset<span class="op">=</span><span class="st">'sib.dob'</span>,   <span class="co"># date of birth</span>
                  time.offset<span class="op">=</span><span class="st">'doi'</span>,      <span class="co"># date of interview</span>
                  exp.scale<span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">12</span><span class="op">)</span></pre></div>
<p>We’re specifying that we want</p>
<ul>
<li>5-year age groups, starting from 15 and ending at 65</li>
<li>to produce estimates for the 7-year window before each survey interview (so, slightly different for each respondent)</li>
<li>the <code>dob</code> column of our sibling dataset has the time siblings start being observed (their birthdate)</li>
<li>the <code>endobs</code> column of our sibling dataset has the time siblings stop being observed (the interview or, if they’re dead, the date of death)</li>
<li>the <code>death.date</code> column of our sibling dataset has the date the sibling died (if the sibling died)</li>
<li>the <code>doi</code> column of our sibling dataset has the date the respondent who reported about the sibling was interviewed</li>
<li>in our survey, times are counted in months, so we set <code>exp.scale=1/12</code> to indicate that we need to divide total exposures by 12 to get years</li>
</ul>
</div>
<div id="estimating-death-rates" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-death-rates" class="anchor"></a>Estimating death rates</h3>
<p>Given these preparatory steps, the <code>sibling_estimator</code> function will take care of estimating death rates from the sibling histories for us.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">ex_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sibling_estimator.html">sibling_estimator</a></span><span class="op">(</span>sib.dat <span class="op">=</span> <span class="va">ex.sib</span>,
                             ego.id <span class="op">=</span> <span class="st">'caseid'</span>,            <span class="co"># column with the respondent id</span>
                             sib.id <span class="op">=</span> <span class="st">'sibid'</span>,             <span class="co"># column with sibling id </span>
                                                           <span class="co"># (unique for each reported sibling)</span>
                             sib.frame.indicator <span class="op">=</span> <span class="st">'in.F'</span>, <span class="co"># indicator for sibling frame population membership</span>
                             sib.sex <span class="op">=</span> <span class="st">'sib.sex'</span>,          <span class="co"># column with sibling's sex</span>
                             cell.config<span class="op">=</span><span class="va">cc</span>,               <span class="co"># cell configuration we created above</span>
                             weights<span class="op">=</span><span class="st">'wwgt'</span><span class="op">)</span>               <span class="co"># column with the respondents' sampling weights</span>

<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ex_ests</span><span class="op">)</span>
<span class="co">#&gt; [1] "asdr.ind" "asdr.agg" "ec.dat"   "esc.dat"</span></pre></div>
<p><code>sibling_estimator</code> returns a list with the results. We’ll focus on <code>asdr.ind</code>, which has the individual visibility estimates, and <code>asdr.agg</code>, which has the aggregate visibility estimates.</p>
<p>Here are the individual visibility estimates:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu">glimpse</span><span class="op">(</span><span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.ind</span><span class="op">)</span>
<span class="co">#&gt; Rows: 20</span>
<span class="co">#&gt; Columns: 10</span>
<span class="co">#&gt; Groups: time.period, sib.sex [2]</span>
<span class="co">#&gt; $ time.period &lt;chr&gt; "7yr_beforeint", "7yr_beforeint", "7yr_beforeint", "7yr_b…</span>
<span class="co">#&gt; $ sib.sex     &lt;chr&gt; "f", "f", "f", "f", "f", "f", "f", "f", "f", "f", "m", "m…</span>
<span class="co">#&gt; $ sib.age     &lt;chr&gt; "[15,20)", "[20,25)", "[25,30)", "[30,35)", "[35,40)", "[…</span>
<span class="co">#&gt; $ num.hat     &lt;dbl&gt; 22.0328126, 28.0821501, 16.2842433, 14.9613173, 10.707900…</span>
<span class="co">#&gt; $ denom.hat   &lt;dbl&gt; 7622.79371, 7864.77994, 6906.23741, 5486.86758, 4286.5537…</span>
<span class="co">#&gt; $ ind.y.F     &lt;dbl&gt; 11400.964, 11400.964, 11400.964, 11400.964, 11400.964, 11…</span>
<span class="co">#&gt; $ n           &lt;int&gt; 6864, 6864, 6864, 6864, 6864, 6864, 6864, 6864, 6864, 686…</span>
<span class="co">#&gt; $ wgt.sum     &lt;dbl&gt; 6798.047, 6798.047, 6798.047, 6798.047, 6798.047, 6798.04…</span>
<span class="co">#&gt; $ asdr.hat    &lt;dbl&gt; 0.002890386, 0.003570621, 0.002357904, 0.002726750, 0.002…</span>
<span class="co">#&gt; $ estimator   &lt;chr&gt; "sib_ind", "sib_ind", "sib_ind", "sib_ind", "sib_ind", "s…</span></pre></div>
<p>And here are the aggregate visibility estimates</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu">glimpse</span><span class="op">(</span><span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.agg</span><span class="op">)</span>
<span class="co">#&gt; Rows: 20</span>
<span class="co">#&gt; Columns: 9</span>
<span class="co">#&gt; Groups: time.period, sib.sex [2]</span>
<span class="co">#&gt; $ time.period &lt;chr&gt; "7yr_beforeint", "7yr_beforeint", "7yr_beforeint", "7yr_b…</span>
<span class="co">#&gt; $ sib.sex     &lt;chr&gt; "f", "f", "f", "f", "f", "f", "f", "f", "f", "f", "m", "m…</span>
<span class="co">#&gt; $ sib.age     &lt;chr&gt; "[15,20)", "[20,25)", "[25,30)", "[30,35)", "[35,40)", "[…</span>
<span class="co">#&gt; $ num.hat     &lt;dbl&gt; 80.640472, 108.425029, 66.546631, 61.344200, 46.548261, 3…</span>
<span class="co">#&gt; $ denom.hat   &lt;dbl&gt; 14696.0833, 15949.0545, 14466.8583, 11597.0465, 8851.6251…</span>
<span class="co">#&gt; $ n           &lt;int&gt; 6864, 6864, 6864, 6864, 6864, 6864, 6864, 6864, 6864, 686…</span>
<span class="co">#&gt; $ wgt.sum     &lt;dbl&gt; 6798.047, 6798.047, 6798.047, 6798.047, 6798.047, 6798.04…</span>
<span class="co">#&gt; $ asdr.hat    &lt;dbl&gt; 0.005487208, 0.006798210, 0.004599937, 0.005289640, 0.005…</span>
<span class="co">#&gt; $ estimator   &lt;chr&gt; "sib_agg", "sib_agg", "sib_agg", "sib_agg", "sib_agg", "s…</span></pre></div>
</div>
<div id="plotting-the-results" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-the-results" class="anchor"></a>Plotting the results</h3>
<p>We’ll make some plots showing the results</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu">ggplot</span><span class="op">(</span><span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.ind</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sib.age</span>, y<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat</span>, color<span class="op">=</span><span class="va">sib.sex</span>, group<span class="op">=</span><span class="va">sib.sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'individual visibility estimator, 7yr before survey'</span><span class="op">)</span></pre></div>
<p><img src="sibling-estimates_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu">ggplot</span><span class="op">(</span><span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.agg</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sib.age</span>, y<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat</span>, color<span class="op">=</span><span class="va">sib.sex</span>, group<span class="op">=</span><span class="va">sib.sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'aggregate visibility estimator, 7yr before survey'</span><span class="op">)</span></pre></div>
<p><img src="sibling-estimates_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">compare</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.ind</span>, <span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.agg</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">compare</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sib.age</span>, y<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat</span>, color<span class="op">=</span><span class="va">sib.sex</span>, linetype<span class="op">=</span><span class="va">estimator</span>, group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="va">estimator</span>, <span class="va">sib.sex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#facet_grid(sex ~ .) +</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">sib.sex</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'both estimators, 7yr before survey'</span><span class="op">)</span></pre></div>
<p><img src="sibling-estimates_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
</div>
<div id="variance-estimates" class="section level2">
<h2 class="hasAnchor">
<a href="#variance-estimates" class="anchor"></a>Variance estimates</h2>
<p>In practice, we want point estimates and estimated sampling uncertainty for the death rates. We’ll use the rescaled bootstrap to estimate sampling uncertainty. This can be done with the <code>surveybootstrap</code> package.</p>
<p>Before we use the rescaled bootstrap, we need to know a little bit about the sampling design of the survey we’re working with. In this example dataset, we have a stratified, multistage design. So we’ll need to tell the bootstrap function about the strata and the primary sampling units. In this example data, these are indicated by the ‘stratum’ and ‘psu’ columns of the dataset.</p>
<p>(NOTE: this takes about a minute or so on a 2018 MBP for 1000 resamples.)</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">101010</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="st">'running bootstrap'</span><span class="op">)</span>
<span class="co">## this will take a little while -- for 1000 reps, it takes about 10 minutes on a 2018 Macbook Pro</span>
<span class="co">#num.boot.reps &lt;- 1000</span>
<span class="co"># reduce number of reps to help vignette build faster</span>
<span class="va">num.boot.reps</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">bootweights</span> <span class="op">&lt;-</span> <span class="fu">surveybootstrap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/surveybootstrap/man/rescaled.bootstrap.weights.html">rescaled.bootstrap.weights</a></span><span class="op">(</span>survey.design <span class="op">=</span> <span class="op">~</span> <span class="va">psu</span> <span class="op">+</span> <span class="fu">stratum</span><span class="op">(</span><span class="va">stratum_analysis</span><span class="op">)</span>,
                                                           <span class="co"># a high number is good here, though that will obviously</span>
                                                           <span class="co"># make everything take longer</span>
                                                           num.reps<span class="op">=</span><span class="va">num.boot.reps</span>,
                                                           idvar<span class="op">=</span><span class="st">'caseid'</span>,       <span class="co"># column with the respondent ids</span>
                                                           weights<span class="op">=</span><span class="st">'wwgt'</span>, <span class="co"># column with the sampling weight</span>
                                                           survey.data<span class="op">=</span><span class="va">ex.ego</span>    <span class="co"># note that we pass in the respondent data, NOT the sibling data</span>
                                                           <span class="op">)</span>
<span class="co">#&gt; Warning: `group_indices_()` is deprecated as of dplyr 0.7.0.</span>
<span class="co">#&gt; Please use `group_indices()` instead.</span>
<span class="co">#&gt; This warning is displayed once every 8 hours.</span>
<span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span>
<span class="co">#&gt; Warning: The `...` argument of `group_keys()` is deprecated as of dplyr 1.0.0.</span>
<span class="co">#&gt; Please `group_by()` first</span>
<span class="co">#&gt; This warning is displayed once every 8 hours.</span>
<span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; running bootstrap: 0.98 sec elapsed</span></pre></div>
<p>The result, <code>bootweights</code>, is a dataframe that has a row for each survey respondent, a column for the survey respondent’s ID, and then <code>num.boot.reps</code> columns containing survey weights that result from the bootstrap procedure. The basic idea is to calculate estimated death rates using each one of the <code>num.boot.reps</code> sets of weights. The variation across the estimates is then an estimator for the sampling variation.</p>
<p>To make this easier, the <code>sibling_estimator</code> function can take a dataset with bootstrap resampled weights; it will then calculate and summarize the estimates for you.</p>
<p>(NOTE: this is slow; it takes about 35 minutes or so on a 2018 MBP when <code>bootweights</code> has 1000 resamples.)</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="co"># to save time, we'll only use a subset of the bootstrap replicates</span>

<span class="va">short.bootweights</span> <span class="op">&lt;-</span> <span class="va">bootweights</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">)</span>

<span class="co">#est.bootweights &lt;- bootweights</span>
<span class="va">est.bootweights</span> <span class="op">&lt;-</span> <span class="va">short.bootweights</span>

<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="st">'calculating estimates with bootstrap'</span><span class="op">)</span>
<span class="va">ex_boot_ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sibling_estimator.html">sibling_estimator</a></span><span class="op">(</span>sib.dat <span class="op">=</span> <span class="va">ex.sib</span>,
                                  ego.id <span class="op">=</span> <span class="st">'caseid'</span>,
                                  sib.id <span class="op">=</span> <span class="st">'sibid'</span>,
                                  sib.frame.indicator <span class="op">=</span> <span class="st">'in.F'</span>,
                                  sib.sex <span class="op">=</span> <span class="st">'sib.sex'</span>,
                                  cell.config<span class="op">=</span><span class="va">cc</span>,
                                  boot.weights<span class="op">=</span><span class="va">est.bootweights</span>,  <span class="co"># to get sampling uncertainty, we pass boot.weights into sibling_estimator</span>
                                  return.boot<span class="op">=</span><span class="cn">TRUE</span>,                <span class="co"># when TRUE, return all of the resampled estimates (not just summaries)</span>
                                  weights<span class="op">=</span><span class="st">'wwgt'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; calculating estimates with bootstrap: 37.235 sec elapsed</span></pre></div>
<p>Finally, let’s plot the estimated death rates along with their sampling uncertainty:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="fu">ggplot</span><span class="op">(</span><span class="va">ex_boot_ests</span><span class="op">$</span><span class="va">asdr.ind</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sib.age</span>, ymin<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat.ci.low</span>, ymax<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat.ci.high</span>, fill<span class="op">=</span><span class="va">sib.sex</span>, group<span class="op">=</span><span class="va">sib.sex</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sib.age</span>, y<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat</span>, color<span class="op">=</span><span class="va">sib.sex</span>, group<span class="op">=</span><span class="va">sib.sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'individual visibility estimator, 7yr before survey'</span><span class="op">)</span>
<span class="co">#&gt; Warning: Transformation introduced infinite values in continuous y-axis</span></pre></div>
<p><img src="sibling-estimates_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="fu">ggplot</span><span class="op">(</span><span class="va">ex_boot_ests</span><span class="op">$</span><span class="va">asdr.agg</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sib.age</span>, ymin<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat.ci.low</span>, ymax<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat.ci.high</span>, fill<span class="op">=</span><span class="va">sib.sex</span>, group<span class="op">=</span><span class="va">sib.sex</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sib.age</span>, y<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat</span>, color<span class="op">=</span><span class="va">sib.sex</span>, group<span class="op">=</span><span class="va">sib.sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'aggregate visibility estimator, 7yr before survey'</span><span class="op">)</span>
<span class="co">#&gt; Warning: Transformation introduced infinite values in continuous y-axis</span></pre></div>
<p><img src="sibling-estimates_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
<div id="internal-consistency-checks" class="section level2">
<h2 class="hasAnchor">
<a href="#internal-consistency-checks" class="anchor"></a>Internal consistency checks</h2>
<p>In this section, we illustrate how to conduct internal consistency checks:</p>
<p>NOTE: The IC checks can take a while – about 36 minutes for 1000 bootstrap reps on a 2018 MBP</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="co"># toggle between short bootweights (faster, for coding) and long bootweights (for realism)</span>
<span class="va">ic.bootweights</span> <span class="op">&lt;-</span> <span class="va">short.bootweights</span>
<span class="co">#ic.bootweights &lt;- bootweights</span>

<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">tic</a></span><span class="op">(</span><span class="st">"Internal consistency checks"</span><span class="op">)</span>
<span class="va">ic.checks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sib_ic_checks.html">sib_ic_checks</a></span><span class="op">(</span><span class="va">ex_boot_ests</span><span class="op">$</span><span class="va">esc.dat</span>,
                           ego.dat<span class="op">=</span><span class="va">ex.ego</span>,
                           ego.id<span class="op">=</span><span class="st">'caseid'</span>,
                           sib.id<span class="op">=</span><span class="st">'sibid'</span>,
                           sib.frame.indicator<span class="op">=</span><span class="st">'in.F'</span>,
                           sib.cell.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sib.age'</span>, <span class="st">'sib.sex'</span><span class="op">)</span>,
                           ego.cell.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'age.cat'</span>, <span class="st">'sex'</span><span class="op">)</span>,
                           boot.weights<span class="op">=</span><span class="va">ic.bootweights</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html">toc</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Internal consistency checks: 0.63 sec elapsed</span>

<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ic.checks</span><span class="op">)</span>
<span class="co">#&gt; [1] "ic.summ"      "ic.boot.ests"</span></pre></div>
<p>We can look at <code>ic.checks$ic.summ</code>, which has summarized output:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu">glimpse</span><span class="op">(</span><span class="va">ic.checks</span><span class="op">$</span><span class="va">ic.summ</span><span class="op">)</span>
<span class="co">#&gt; Rows: 7</span>
<span class="co">#&gt; Columns: 15</span>
<span class="co">#&gt; $ cell             &lt;chr&gt; "[15,20)_X_f", "[20,25)_X_f", "[25,30)_X_f", "[30,35…</span>
<span class="co">#&gt; $ age.cat          &lt;chr&gt; "[15,20)", "[20,25)", "[25,30)", "[30,35)", "[35,40)…</span>
<span class="co">#&gt; $ sex              &lt;chr&gt; "f", "f", "f", "f", "f", "f", "f"</span>
<span class="co">#&gt; $ diff_mean        &lt;dbl&gt; 237.04784, -279.75665, -3.38159, -163.19049, 227.432…</span>
<span class="co">#&gt; $ abs_diff_mean    &lt;dbl&gt; 237.0478, 279.7566, 106.6174, 163.1905, 227.4326, 22…</span>
<span class="co">#&gt; $ diff2_mean       &lt;dbl&gt; 63973.98, 79139.39, 16222.04, 28804.52, 59759.73, 58…</span>
<span class="co">#&gt; $ diff_se          &lt;dbl&gt; 92.98927, 31.19132, 134.20800, 49.14136, 94.48180, 7…</span>
<span class="co">#&gt; $ abs_diff_se      &lt;dbl&gt; 92.98927, 31.19132, 73.44523, 49.14136, 94.48180, 78…</span>
<span class="co">#&gt; $ diff2_se         &lt;dbl&gt; 42609.67, 17657.43, 22881.11, 16061.31, 36740.01, 33…</span>
<span class="co">#&gt; $ diff_ci_low      &lt;dbl&gt; 97.03007, -327.16213, -160.61038, -237.50409, 49.768…</span>
<span class="co">#&gt; $ abs_diff_ci_low  &lt;dbl&gt; 97.03007, 235.54499, 28.30904, 84.56564, 49.76817, 1…</span>
<span class="co">#&gt; $ diff2_ci_low     &lt;dbl&gt; 10077.4483, 55579.2367, 993.9034, 7317.8783, 4093.27…</span>
<span class="co">#&gt; $ diff_ci_high     &lt;dbl&gt; 355.88593, -235.54499, 241.64752, -84.56564, 338.318…</span>
<span class="co">#&gt; $ abs_diff_ci_high &lt;dbl&gt; 355.8859, 327.1621, 253.3625, 237.5041, 338.3189, 31…</span>
<span class="co">#&gt; $ diff2_ci_high    &lt;dbl&gt; 126888.68, 107060.00, 66087.25, 56472.20, 114722.50,…</span></pre></div>
<p>It’s often helpful to plot the results of the internal consistency checks:</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="fu">ggplot</span><span class="op">(</span><span class="va">ic.checks</span><span class="op">$</span><span class="va">ic.summ</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_hline</span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_pointrange</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">age.cat</span>,
                      y<span class="op">=</span><span class="va">diff_mean</span>,
                      ymin<span class="op">=</span><span class="va">diff_ci_low</span>,
                      ymax<span class="op">=</span><span class="va">diff_ci_high</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Internal consistency checks"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Age group"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ylab</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">Delta</span><span class="op">[</span><span class="va">alpha</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="sibling-estimates_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit">

<span class="co">#ggplot(ic.checks$ic.summ) +</span>
<span class="co">#  geom_hline(yintercept=0) +</span>
<span class="co">#  geom_pointrange(aes(x=age.cat,</span>
<span class="co">#                      y=agg_diff_mean,</span>
<span class="co">#                      ymin=agg_diff_ci_low,</span>
<span class="co">#                      ymax=agg_diff_ci_high)) +</span>
<span class="co">#  theme_minimal() +</span>
<span class="co">#  ggtitle("Internal consistency checks (aggregate)") +</span>
<span class="co">#  xlab("Age group") +</span>
<span class="co">#  ylab(expression(Delta[alpha]))</span>
<span class="co">#</span>
<span class="co">#ggplot(ic.checks$ic.summ) +</span>
<span class="co">#  geom_hline(yintercept=0) +</span>
<span class="co">#  geom_pointrange(aes(x=age.cat,</span>
<span class="co">#                      y=ind_diff_mean,</span>
<span class="co">#                      ymin=ind_diff_ci_low,</span>
<span class="co">#                      ymax=ind_diff_ci_high)) +</span>
<span class="co">#  theme_minimal() +</span>
<span class="co">#  ggtitle("Internal consistency checks (individual)") +</span>
<span class="co">#  xlab("Age group") +</span>
<span class="co">#  ylab(expression(Delta[alpha]))</span></pre></div>
</div>
<div id="visibilities" class="section level2">
<h2 class="hasAnchor">
<a href="#visibilities" class="anchor"></a>Visibilities</h2>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">sib.F.dat</span> <span class="op">&lt;-</span> <span class="va">ex.sib</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">caseid</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarize</span><span class="op">(</span>y.F <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">in.F</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="va">ego.vis</span> <span class="op">&lt;-</span> <span class="va">ex.ego</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">caseid</span>, <span class="va">wwgt</span>, <span class="va">age.cat</span>, <span class="va">sex</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">sib.F.dat</span>, by<span class="op">=</span><span class="st">'caseid'</span><span class="op">)</span>

<span class="co"># if nothing was joined in, there are no sibs</span>
<span class="va">ego.vis</span> <span class="op">&lt;-</span> <span class="va">ego.vis</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>y.F<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">y.F</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">y.F</span><span class="op">)</span><span class="op">)</span>

<span class="va">ego.vis.agg</span> <span class="op">&lt;-</span> <span class="va">ego.vis</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">sex</span>, <span class="va">age.cat</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>y.F.bar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/surveybootstrap/man/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">y.F</span>, <span class="va">wwgt</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>adj.factor <span class="op">=</span> <span class="va">y.F.bar</span> <span class="op">/</span> <span class="op">(</span><span class="va">y.F.bar</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'sex' (override with `.groups` argument)</span></pre></div>
<p>Make adjusted individual estimates</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="va">adj.agg.ests</span> <span class="op">&lt;-</span> <span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.agg</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">ego.vis.agg</span>,
            by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sib.sex'</span><span class="op">=</span><span class="st">'sex'</span>, <span class="st">'sib.age'</span><span class="op">=</span><span class="st">'age.cat'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>adj.factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">adj.factor</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">adj.factor</span><span class="op">)</span>,
         estimator <span class="op">=</span> <span class="st">'sib_agg_adj'</span>,
         asdr.hat <span class="op">=</span> <span class="va">asdr.hat</span> <span class="op">*</span> <span class="va">adj.factor</span><span class="op">)</span></pre></div>
<p>And plot a comparison</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="va">compare</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.ind</span>, <span class="va">ex_ests</span><span class="op">$</span><span class="va">asdr.agg</span>, <span class="va">adj.agg.ests</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">compare</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sib.age</span>, y<span class="op">=</span><span class="fl">1000</span><span class="op">*</span><span class="va">asdr.hat</span>, color<span class="op">=</span><span class="va">sib.sex</span>, linetype<span class="op">=</span><span class="va">estimator</span>, group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="va">estimator</span>, <span class="va">sib.sex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">#facet_grid(sex ~ .) +</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">sib.sex</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'sibling estimators, 7yr before survey'</span><span class="op">)</span></pre></div>
<p><img src="sibling-estimates_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<!--
## TODO

* add calculation of visibilities by respondent, calculate avg vis by cell
* make it easier to produce adjusted estimates; demonstrate with S/(S+1) issue
* add normalization to IC checks
* make it easier to calculate IC checks by single year of age?
* right now, sibling_estimator now has hard-coded 'agelabel' references -- but it shouldn't? need to handle this more elegantly


# PROFILING

## TO PROFILE: BOOTSTRAP WEIGHTS

(NOTE: this takes about a minute or so on a 2018 MBP for 1000 resamples.)


```r
set.seed(101010)

tic('running bootstrap')
## this will take a little while -- for 1000 reps, it takes about 1 minutes on a 2018 Macbook Pro
#num.boot.reps <- 1000
# use a small number of reps to avoid the vignette taking forever to build
num.boot.reps <- 100
test.bootweights <- surveybootstrap::rescaled.bootstrap.weights(survey.design = ~ psu + stratum(stratum_analysis),
                                                           # a high number is good here, though that will obviously
                                                           # make everything take longer
                                                           num.reps=num.boot.reps,
                                                           idvar='caseid',       # column with the respondent ids
                                                           weights='wwgt', # column with the sampling weight
                                                           survey.data=ex.ego    # note that we pass in the respondent data, NOT the sibling data
                                                           )
toc()
```

-->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dennis M. Feehan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
